general:
  branches:
    only:
      - oice
      - oice_test

machine:
  environment:
    PROJECT_NAME: api-project-82698378
    CLUSTER_NAME: oice-test
    CLOUDSDK_COMPUTE_ZONE: asia-east1-b
    PROD_CLUSTER_NAME: oice-production
    PROD_CLOUDSDK_COMPUTE_ZONE: asia-east1-a
    DEBIAN_FRONTEND: noninteractive
    GOOGLE_APPLICATION_CREDENTIALS: ${HOME}/account-auth.json
  services:
    - docker
    - redis
  hosts:
    redis: 127.0.0.1

checkout:
  post:
    - git submodule sync
    - git submodule update --init

dependencies:
  cache_directories:
    - /opt/google-cloud-sdk
  override:
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update kubectl
    - echo $GCLOUD_SERVICE_KEY_OICE | base64 --decode -i > ${HOME}/account-auth.json
    - sudo /opt/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file ${HOME}/account-auth.json
    - sudo /opt/google-cloud-sdk/bin/gcloud config set project $PROJECT_NAME
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet config set container/cluster $CLUSTER_NAME
    # Reading the zone from the env var is not working so we set it here
    - sudo /opt/google-cloud-sdk/bin/gcloud config set compute/zone ${CLOUDSDK_COMPUTE_ZONE}
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet container clusters get-credentials $CLUSTER_NAME
    - sudo /opt/google-cloud-sdk/bin/gcloud docker -- pull asia.gcr.io/${PROJECT_NAME}/modmod:$MODMOD_CIRCLE_SHA1 || true
    - docker tag -f asia.gcr.io/${PROJECT_NAME}/modmod:$MODMOD_CIRCLE_SHA1 modmod
    - sudo /opt/google-cloud-sdk/bin/gcloud docker -- pull asia.gcr.io/${PROJECT_NAME}/o2rqworker:latest || true
    - ./build.sh
    - docker tag -f o2rqworker:latest asia.gcr.io/${PROJECT_NAME}/o2rqworker:latest
    - docker tag -f o2rqworker:latest asia.gcr.io/${PROJECT_NAME}/o2rqworker:${MODMOD_CIRCLE_SHA1}_${CIRCLE_SHA1}

test:
  override:
    - docker run o2rqworker /builder3/o2_build.sh /tmp /tmp               # check if node is working
    - docker run --net=host -d --name "o2rqworker" o2rqworker; sleep 10   # try setup rq worker
    - docker kill "o2rqworker"                                            # if cannot kill, rq worker has crashed, otherwise pass

deployment:
  staging:
    branch: oice_test
    commands:
      - sudo /opt/google-cloud-sdk/bin/gcloud docker -- push asia.gcr.io/${PROJECT_NAME}/o2rqworker:latest
      - sudo /opt/google-cloud-sdk/bin/gcloud docker -- push asia.gcr.io/${PROJECT_NAME}/o2rqworker:${MODMOD_CIRCLE_SHA1}_${CIRCLE_SHA1}
      - sudo chown -R ubuntu:ubuntu /home/ubuntu/.kube
      - kubectl patch deployment modmod-worker -p '{"spec":{"template":{"spec":{"containers":[{"name":"modmod-worker","image":"asia.gcr.io/'"$PROJECT_NAME"'/o2rqworker:'"$MODMOD_CIRCLE_SHA1"'_'"$CIRCLE_SHA1"'"}]}}}}'
  production:
    branch: oice
    commands:
      - sudo /opt/google-cloud-sdk/bin/gcloud docker -- push asia.gcr.io/${PROJECT_NAME}/o2rqworker:latest
      - sudo /opt/google-cloud-sdk/bin/gcloud docker -- push asia.gcr.io/${PROJECT_NAME}/o2rqworker:${MODMOD_CIRCLE_SHA1}_${CIRCLE_SHA1}
      - sudo /opt/google-cloud-sdk/bin/gcloud config set compute/zone ${PROD_CLOUDSDK_COMPUTE_ZONE}
      - sudo /opt/google-cloud-sdk/bin/gcloud --quiet config set container/cluster $PROD_CLUSTER_NAME
      - sudo /opt/google-cloud-sdk/bin/gcloud --quiet container clusters get-credentials $PROD_CLUSTER_NAME
      - sudo chown -R ubuntu:ubuntu /home/ubuntu/.kube
      - kubectl patch deployment modmod-worker -p '{"spec":{"template":{"spec":{"containers":[{"name":"modmod-worker","image":"asia.gcr.io/'"$PROJECT_NAME"'/o2rqworker:'"$MODMOD_CIRCLE_SHA1"'_'"$CIRCLE_SHA1"'"}]}}}}'
