var util=require("util"),fs=require("fs"),path=require("path"),config=require("../config.js").config,command=require("commander");command.option("-l, --legacy","Legacy\u30e2\u30fc\u30c9\u3092\u4f7f\u3046").option("-r, --release","Release\u30e2\u30fc\u30c9\u3092\u4f7f\u3046").parse(process.argv);var Tag=function(){this.name=void 0;this.args={};this.charNumber=this.lineNumber=void 0};
Tag.prototype.toJSON=function(){var d=[];d[config.scriptTagNameKey]=this.name;Object.keys(this.args).length?d[config.scriptTagArgsKey]=this.args:command.release||(d[config.scriptTagArgsKey]=0);command.release||(d[config.scriptTagLineKey]=this.lineNumber,d[config.scriptTagCharKey]=this.charNumber);return d};
var TagBuilder=function(d){INPUT_MODE_NAME=1;INPUT_MODE_ATTR_NAME=2;INPUT_MODE_ATTR_VALUE=3;this.currentTag=void 0;var g=0,h=void 0,e=void 0;this.startTag=function(c,d){if(void 0!=this.currentTag)throw"\u3059\u3067\u306b\u30bf\u30b0\u5b9a\u7fa9\u4e2d\u3067\u3059\u3002";this.currentTag=new Tag;this.currentTag.lineNumber=c;this.currentTag.charNumber=d;g=0};this.appendTagName=function(c){if(!this.currentTag)throw"\u30bf\u30b0\u306e\u5916\u3067\u30bf\u30b0\u540d\u524d\u3092\u767b\u9332\u3057\u3088\u3046\u3068\u3057\u3066\u308b";
if(g>INPUT_MODE_NAME)throw"\u4eca\u306f\u30bf\u30b0\u540d\u3092\u6307\u5b9a\u3067\u304d\u306a\u3044\u3002";g=INPUT_MODE_NAME;this.currentTag.name=void 0===this.currentTag.name?c:this.currentTag.name+c};this.appendAttrName=function(c){if(!this.currentTag)throw"\u30bf\u30b0\u5916\u3067\u5c5e\u6027\u540d\u3092\u767b\u9332\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u307e\u3059";if(g===INPUT_MODE_ATTR_VALUE){if(e)throw"\u5c5e\u6027\u306e\u5024\u3092\u5165\u308c\u305f\u5f8c\u306b\u5c5e\u6027\u540d\u3092\u5909\u3048\u3088\u3046\u3068\u3057\u3066\u3044\u307e\u3059";
this.endAttrValue()}g=INPUT_MODE_ATTR_NAME;h||(h="");h+=c};this.endAttrName=function(){g=INPUT_MODE_ATTR_VALUE};this.appendAttrValue=function(c){if(!this.currentTag)throw"\u30bf\u30b0\u5916\u3067\u5c5e\u6027\u5024\u3092\u767b\u9332\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u307e\u3059";g=INPUT_MODE_ATTR_VALUE;e||(e="");e+=c};this.endAttrValue=function(){if("undefined"===typeof h)throw"\u5c5e\u6027\u540d\u3092\u6307\u5b9a\u3057\u3066\u3044\u307e\u305b\u3093";"undefined"===typeof e&&(e="true");this.currentTag.args[h]=
e;e=h=void 0;g=0};this.closeTag=function(){if(!this.currentTag)throw"\u30bf\u30b0\u4e2d\u3067\u306f\u3042\u308a\u307e\u305b\u3093";g!=INPUT_MODE_ATTR_VALUE&&g!=INPUT_MODE_ATTR_NAME||this.endAttrValue();if(!this.currentTag.name)throw"\u30bf\u30b0\u540d\u304c\u3042\u308a\u307e\u305b\u3093";this.currentTag.name=this.currentTag.name.toLowerCase();d.push(this.currentTag);this.resetTag()};this.currentTagName=function(){return this.currentTag?this.currentTag.name:void 0};this.resetTag=function(){this.currentTag=
void 0;g=0}},TAG_MODE_NONE=0,TAG_MODE_BRACKET=1,TAG_MODE_AT=2,TAG_MODE_TEXT=3,TAG_MODE_LABEL=4,ATTR_MODE_NONE=0,ATTR_MODE_TAG_NAME=1,ATTR_MODE_NAME=2,ATTR_MODE_NAME_END=3,ATTR_MODE_VALUE_START=4,ATTR_MODE_NO_QUOTE=5,ATTR_MODE_QUOTE=6,SYNTAX_MODE_STANDARD=0,SYNTAX_MODE_LEGACY=1,syntaxMode=SYNTAX_MODE_STANDARD;command.legacy&&(syntaxMode=SYNTAX_MODE_LEGACY);var warnings=[];
exports.parse=function(d,g){function h(c,a){for(var b=c+1;b<=a;b++)"\n"==d.charAt(b)?(m++,k=0):k++}d=d.replace(/\r\n|\r/g,"\n");d+="\n";var e=TAG_MODE_NONE,c=ATTR_MODE_NONE,l=[],b=new TagBuilder(l),m=1,k=1;warnings=[];try{for(var f=0;f<d.length;f++)if(65279!=d.charCodeAt(f)){var a=d.charAt(f),n=d.charAt(f+1);"\u301c"==a&&(a="\uff5e");k++;"\n"==a&&(m++,k=0);var q=b.currentTagName();if(c!=ATTR_MODE_QUOTE&&(e==TAG_MODE_AT&&"\n"===a||e==TAG_MODE_BRACKET&&"]"===a)&&q&&q.isOneOf(["iscript","o2_iscript"])||
"/"==a&&"*"==n){b.resetTag();var e=TAG_MODE_NONE,e=ATTR_MODE_NONE,v=d.substr(f),r,s;switch(q){case "iscript":r=/[@|\[][\t|\s]*endscript[\t|\s]*]?/;s="[ERROR100] iscript\u30bf\u30b0\u306b\u5bfe\u5fdc\u3059\u308bendscript\u30bf\u30b0\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093";break;case "o2_iscript":r=/[@|\[][\t|\s]*o2_endscript[\t|\s]*]?/;s="[ERROR101] o2_iscript\u306b\u5bfe\u5fdc\u3059\u308bo2_endscript\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093";break;default:r=/\*\//,s="[ERROR102] \u8907\u6570\u884c\u30b3\u30e1\u30f3\u30c8\u304c\u9589\u3058\u3089\u308c\u3066\u3044\u307e\u305b\u3093"}var p=
v.match(r);if(!p||!p.length)throw s;if("o2_iscript"==q){var w=d.substring(f+1,p.index+f);b.startTag(m,k);b.appendTagName("o2_iscript");b.appendAttrName("o2_exp");b.appendAttrValue(w);b.closeTag()}var u=f+p.index+p[0].length-1;h(f,u);f=u}else{if(";"===a&&function(){if(syntaxMode==SYNTAX_MODE_LEGACY){if(0==f)return!0;for(var a=f-1;0<=a;a--){var b=d.charAt(a);if("\n"==b)return!0;if("\t"!=b)break}}else if(c!=ATTR_MODE_QUOTE)return!0;return!1}()){var t=function(){for(var a=f;a<d.length;a++)if("\n"==d.charAt(a))return a;
return-1}();if(-1!=t){h(f,t-1);f=t-1;continue}}if(e===TAG_MODE_NONE)if("@"===a)e=TAG_MODE_AT,b.startTag(m,k);else{if("["===a){if("["!=n){e=TAG_MODE_BRACKET;b.startTag(m,k);continue}}else if("*"===a){b.startTag(m,k);e=TAG_MODE_LABEL;b.appendTagName("label");b.appendAttrName("name");continue}if(!a.isOneOf(["\t","\n"])||"["==a&&"["==n)e=TAG_MODE_TEXT,b.startTag(m,k),b.appendTagName("text"),b.appendAttrName("text"),b.endAttrName(),b.appendAttrValue(a),"["==a&&"["==n&&f++}else if(e===TAG_MODE_TEXT)d.charAt(f+
2),"["==a?"["==n?(f++,b.appendAttrValue(a)):(b.closeTag(),e=TAG_MODE_NONE,c=ATTR_MODE_NONE,f--):"\n"==a||"\t"==n?(b.closeTag(),e=TAG_MODE_NONE,c=ATTR_MODE_NONE):b.appendAttrValue(a);else if(e===TAG_MODE_LABEL)"\n"==a?(b.closeTag(),e=TAG_MODE_NONE):"|"==a?(b.endAttrValue(),b.appendAttrName("caption")):b.appendAttrValue(a);else if(c!=ATTR_MODE_QUOTE&&(e==TAG_MODE_AT&&"\n"===a||e==TAG_MODE_BRACKET&&"]"===a))b.closeTag(),e=TAG_MODE_NONE,c=ATTR_MODE_NONE;else{if(syntaxMode==SYNTAX_MODE_LEGACY&&"\n"==a){if(c==
ATTR_MODE_QUOTE)throw"[ERROR201] KAG3\u4e92\u63db\u6587\u6cd5\u30e2\u30fc\u30c9\u3067\u306f\u30bf\u30b0\u3084\u5024\u306e\u4e2d\u3067\u6539\u884c\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093";throw"[ERROR200] KAG3\u4e92\u63db\u6587\u6cd5\u30e2\u30fc\u30c9\u3067\u306f\u30bf\u30b0\u306e\u4e2d\u3067\u6539\u884c\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093";}c!==ATTR_MODE_NONE||b.currentTag.name||a.isOneOf([" ","\t","\n"])?c===ATTR_MODE_TAG_NAME?a.isOneOf([" ","\t","\n"])?
c=ATTR_MODE_NONE:b.appendTagName(a):c!==ATTR_MODE_NONE||a.isOneOf([" ","\t","\n"])?c===ATTR_MODE_NAME?a.isOneOf([" ","\t","\n"])?c=ATTR_MODE_NAME_END:"="===a?c=ATTR_MODE_VALUE_START:b.appendAttrName(a):c===ATTR_MODE_NAME_END?"="===a?c=ATTR_MODE_VALUE_START:a.isOneOf(["\t"," ","\n"])||(b.endAttrValue(),c=ATTR_MODE_NONE,f--):c!==ATTR_MODE_VALUE_START||a.isOneOf([" ","\u3000","\n"])?c===ATTR_MODE_QUOTE?a.isOneOf(['"'])?(c=ATTR_MODE_NONE,b.endAttrValue()):b.appendAttrValue(a):c===ATTR_MODE_NO_QUOTE&&
(a.isOneOf([" ","\t","\n"])?(c=ATTR_MODE_NONE,b.endAttrValue()):b.appendAttrValue(a)):'"'===a?(c=ATTR_MODE_QUOTE,b.appendAttrValue("")):(c=ATTR_MODE_NO_QUOTE,b.appendAttrValue(a)):(c=ATTR_MODE_NAME,b.appendAttrName(a)):(c=ATTR_MODE_TAG_NAME,b.appendTagName(a))}}}if(c!=ATTR_MODE_NONE)throw"[ERROR103] \u30bf\u30b0\u5185\u306e\u5024\u304c\u7d42\u4e86\u3057\u306a\u3044\u307e\u307e\u30d5\u30a1\u30a4\u30eb\u306e\u7d42\u7aef\u306b\u9054\u3057\u307e\u3057\u305f";if(e!=TAG_MODE_NONE)throw"[ERROR104] \u30bf\u30b0\u304c\u9589\u3058\u306a\u3044\u307e\u307e\u30d5\u30a1\u30a4\u30eb\u306e\u7d42\u7aef\u306b\u9054\u3057\u307e\u3057\u305f";
}catch(x){throw g+" Line:"+m+" Char:"+k+"\n"+x;}return{scripts:l,warnings:warnings}};exports.parseFiles=function(d){for(var g={},h=[],e=0;e<d.length;e++){var c=fs.readFileSync(path.normalize(d[e]),"utf8"),c=exports.parse(c,d[e]),l=path.basename(d[e]);g[l]=c.scripts;for(l=0;l<c.warnings.length;l++)h.push("File: "+d[e]+" "+c.warnings[l])}return{scripts:g,warnings:h}};exports.main=function(d){d.length||(console.log("Usage: builder.js FILE1 [FILE2 ...]"),process.exit(1));return JSON.stringify(exports.parseFiles(d))};
String.prototype.isOneOf=function(d){"string"===typeof d&&(d=[d]);for(var g=0;g<d.length;g++)if(this==d[g])return!0;return!1};if("undefined"!==typeof module&&require.main===module)try{var result=exports.main(command.args);util.print(result)}catch(e$$13){console.error(e$$13)};