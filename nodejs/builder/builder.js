var util=require("util"),fs=require("fs"),path=require("path"),config=require("../config.js").config,command=require("commander");command.option("-l, --legacy","Legacyモードを使う").option("-r, --release","Releaseモードを使う").parse(process.argv);var Tag=function(){this.name=void 0,this.args={},this.lineNumber=void 0,this.charNumber=void 0,this.callbackArgs=[],this.isOpen=!1,this.isClose=!1};Tag.prototype.toJSON=function(){var t=[];t[config.scriptTagNameKey]=this.name,Object.keys(this.args).length?t[config.scriptTagArgsKey]=this.args:t[config.scriptTagArgsKey]=0,command.release&&!this.isOpen||(t[config.scriptTagCallbackArgsKey]=this.isOpen?this.callbackArgs:0),command.release||(t[config.scriptTagLineKey]=this.lineNumber,t[config.scriptTagCharKey]=this.charNumber),this.isClose&&(t[config.scriptTagNameKey]="/");for(var e=t.length-1;e>=0;e--){var r=t[e];if(0!==r&&null!=r)break;t.splice(e,1)}return t};var TagBuilder=function(t){this.currentTag=void 0;var e=0,r=void 0,a=void 0,n=[];this.startTag=function(t,r){if(void 0!=this.currentTag)throw"すでにタグ定義中です。";this.currentTag=new Tag,this.currentTag.lineNumber=t,this.currentTag.charNumber=r,e=0},this.appendTagName=function(t){if(!this.currentTag)throw"タグの外でタグ名前を登録しようとしてる";if(e>1)throw"今はタグ名を指定できない。";e=1,void 0===this.currentTag.name?this.currentTag.name=t:this.currentTag.name+=t},this.appendAttrName=function(t){if(!this.currentTag)throw"タグ外で属性名を登録しようとしています";if(this.currentTag.isClose)throw"閉じタグに属性を入れてはいけません。";if(3===e){if(a)throw"属性の値を入れた後に属性名を変えようとしています";this.endAttrValue()}e=2,r||(r=""),r+=t},this.endAttrName=function(){e=3},this.appendAttrValue=function(t){if(!this.currentTag)throw"タグ外で属性値を登録しようとしています";e=3,a||(a=""),a+=t},this.endAttrValue=function(){if(void 0===r)throw"属性名を指定していません";void 0===a&&(a=null),this.currentTag.args[r]=a,r=void 0,a=void 0,e=0},this.appendCallbackArgs=function(t){if(4===e){var r=this.currentTag.callbackArgs.length-1;this.currentTag.callbackArgs[r]+=t}else e=4,this.currentTag.callbackArgs.push(t)},this.endCallbackArgs=function(){e=5},this.markAsOpenTag=function(){this.currentTag.isOpen=!0},this.markAsCloseTag=function(){this.currentTag.isClose=!0},this.closeTag=function(){if(!this.currentTag)throw"タグ中ではありません";if(3!=e&&2!=e||this.endAttrValue(),!this.currentTag.name&&!this.currentTag.isClose)throw"タグ名がありません";if(this.currentTag.isOpen&&this.currentTag.isClose)throw"close tagにcallbackは指定できないです";if(this.currentTag.isOpen)n.push(this.currentTag.name);else if(this.currentTag.isClose){var r=n.pop();if(!r)throw"ここで閉じられるタグがないです";if(this.currentTag.name&&r!==this.currentTag.name)throw"ここは"+r+"を閉じるべきですが、"+this.currentTag.name+"を閉じてます";this.currentTag.name=r}for(var a in this.currentTag.args)null===this.currentTag.args[a]&&(this.currentTag.args[a]="true");this.currentTag.name=this.currentTag.name.toLowerCase(),t.push(this.currentTag),this.resetTag()},this.currentTagName=function(){if(this.currentTag)return this.currentTag.name},this.resetTag=function(){this.currentTag=void 0,e=0}},TAG_MODE_NONE=0,TAG_MODE_BRACKET=1,TAG_MODE_AT=2,TAG_MODE_TEXT=3,TAG_MODE_LABEL=4,ATTR_MODE_NONE=0,ATTR_MODE_TAG_NAME=1,ATTR_MODE_NAME=2,ATTR_MODE_NAME_END=3,ATTR_MODE_VALUE_START=4,ATTR_MODE_NO_QUOTE=5,ATTR_MODE_QUOTE=6,ATTR_MODE_CALLBACK=7,ATTR_MODE_CALLBACK_ARG=8,SYNTAX_MODE_STANDARD=0,SYNTAX_MODE_LEGACY=1,syntaxMode=SYNTAX_MODE_STANDARD;command.legacy&&(syntaxMode=SYNTAX_MODE_LEGACY);var warnings=[],lastLabelName=void 0,lastLabelEmptyCount=void 0;if(exports.parse=function(t,e){function r(e,r){for(var a=e+1;a<=r;a++)"\n"==t.charAt(a)?(T++,A=0):A++}t=t.replace(/\r\n|\r/g,"\n"),t+="\n";var a=TAG_MODE_NONE,n=ATTR_MODE_NONE,i=[],s=new TagBuilder(i),T=1,A=1;warnings=[];try{for(var _=0;_<t.length;_++)if(65279!=t.charCodeAt(_)){var c=t.charAt(_),O=t.charAt(_+1);"〜"==c&&(c="～"),A++,"\n"==c&&(T++,A=0);var o=s.currentTagName();if(n!=ATTR_MODE_QUOTE&&(a==TAG_MODE_AT&&"\n"===c||a==TAG_MODE_BRACKET&&"]"===c)&&o&&o.isOneOf(["iscript","o2_iscript"])||n!=ATTR_MODE_QUOTE&&"/"==c&&"*"==O){s.resetTag(),a=TAG_MODE_NONE,n=ATTR_MODE_NONE;var E,g,u=t.substr(_);switch(o){case"iscript":E=/[@|\[][\t|\s]*endscript[\t|\s]*]?/,g="[ERROR100] iscriptタグに対応するendscriptタグが見つかりません";break;case"o2_iscript":E=/[@|\[][\t|\s]*o2_endscript[\t|\s]*]?/,g="[ERROR101] o2_iscriptに対応するo2_endscriptが見つかりません";break;default:E=/\*\//,g="[ERROR102] 複数行コメントが閉じられていません"}var l=u.match(E);if(!l||!l.length)throw g;if("o2_iscript"==o){var h=t.substring(_+1,l.index+_);s.startTag(T,A),s.appendTagName("o2_iscript"),s.appendAttrName("o2_exp"),s.appendAttrValue(h),s.closeTag()}var p=l[0],f=_+l.index+p.length-1;r(_,f),_=f}else{if(";"===c&&function(){if(syntaxMode==SYNTAX_MODE_LEGACY){if(0==_)return!0;for(var e=_-1;e>=0;e--){var r=t.charAt(e);if("\n"==r)return!0;if("\t"!=r)return!1}}else if(n!=ATTR_MODE_QUOTE)return!0;return!1}()){var N=function(){for(var e=_;e<t.length;e++)if("\n"==t.charAt(e))return e;return-1}();if(-1!=N){r(_,N-1),_=N-1;continue}}if(a===TAG_MODE_NONE){if("@"===c){a=TAG_MODE_AT,s.startTag(T,A);continue}if("["===c){if("["!=O){a=TAG_MODE_BRACKET,s.startTag(T,A);continue}}else if("*"===c){s.startTag(T,A),a=TAG_MODE_LABEL,s.appendTagName("label"),s.appendAttrName("name");continue}(!c.isOneOf(["\t","\n"])||"["==c&&"["==O)&&(a=TAG_MODE_TEXT,s.startTag(T,A),s.appendTagName("text"),s.appendAttrName("text"),s.endAttrName(),s.appendAttrValue(c),"["==c&&"["==O&&_++)}else{if(a===TAG_MODE_TEXT){t.charAt(_+2);"["==c?"["==O?(_++,s.appendAttrValue(c)):(s.closeTag(),a=TAG_MODE_NONE,n=ATTR_MODE_NONE,_--):"\n"==c||"\t"==O?(s.closeTag(),a=TAG_MODE_NONE,n=ATTR_MODE_NONE):s.appendAttrValue(c);continue}if(a===TAG_MODE_LABEL){if("\n"==c){if(s.endAttrValue(),null===s.currentTag.args.name){if(void 0===lastLabelEmptyCount)throw"シナリオの最初のラベルは名前が必要です。";lastLabelEmptyCount++,s.currentTag.args.name=lastLabelName+":"+lastLabelEmptyCount}else lastLabelEmptyCount=1,lastLabelName=s.currentTag.args.name;null===s.currentTag.args.caption&&(s.currentTag.args.caption=""),s.closeTag(),a=TAG_MODE_NONE}else"|"==c?(s.endAttrValue(),s.appendAttrName("caption")):s.appendAttrValue(c);continue}if(n!=ATTR_MODE_QUOTE&&(a==TAG_MODE_AT&&"\n"===c||a==TAG_MODE_BRACKET&&"]"===c))s.closeTag(),a=TAG_MODE_NONE,n=ATTR_MODE_NONE;else{if(syntaxMode==SYNTAX_MODE_LEGACY&&"\n"==c)throw n==ATTR_MODE_QUOTE?"[ERROR201] KAG3互換文法モードではタグや値の中で改行することはできません":"[ERROR200] KAG3互換文法モードではタグの中で改行することはできません";n!==ATTR_MODE_NONE||s.currentTagName()||"/"!==c?n!==ATTR_MODE_NONE||s.currentTag.name||c.isOneOf([" ","\t","\n"])?n===ATTR_MODE_TAG_NAME?c.isOneOf([" ","\t","\n"])?n=ATTR_MODE_NONE:s.appendTagName(c):n!==ATTR_MODE_NONE||c.isOneOf([" ","\t","\n","(","-"])?n===ATTR_MODE_NAME?c.isOneOf([" ","\t","\n"])?n=ATTR_MODE_NAME_END:"="===c?n=ATTR_MODE_VALUE_START:s.appendAttrName(c):n===ATTR_MODE_NAME_END?"="===c?n=ATTR_MODE_VALUE_START:c.isOneOf(["\t"," ","\n"])||(s.endAttrValue(),n=ATTR_MODE_NONE,_--):n!==ATTR_MODE_VALUE_START||c.isOneOf([" ","　","\n"])?n===ATTR_MODE_QUOTE?c.isOneOf(["`"])?(s.appendAttrValue(O),_+=1):c.isOneOf(['"'])?(n=ATTR_MODE_NONE,s.endAttrValue()):s.appendAttrValue(c):n===ATTR_MODE_NO_QUOTE?c.isOneOf([" ","\t","\n"])?(n=ATTR_MODE_NONE,s.endAttrValue()):s.appendAttrValue(c):n===ATTR_MODE_NONE&&c.isOneOf(["-","("])?n=ATTR_MODE_CALLBACK:n!==ATTR_MODE_CALLBACK&&n!==ATTR_MODE_CALLBACK_ARG||c.isOneOf([",","(",")"," ","\n","\t","-",">"])?n!==ATTR_MODE_CALLBACK&&n!==ATTR_MODE_CALLBACK_ARG||!c.isOneOf([",",")"])?n===ATTR_MODE_CALLBACK&&">"===c&&(s.markAsOpenTag(),n=ATTR_MODE_NONE):(s.endCallbackArgs(),n=ATTR_MODE_CALLBACK):(n=ATTR_MODE_CALLBACK_ARG,s.appendCallbackArgs(c)):'"'===c?(n=ATTR_MODE_QUOTE,s.appendAttrValue("")):(n=ATTR_MODE_NO_QUOTE,s.appendAttrValue(c)):(n=ATTR_MODE_NAME,s.appendAttrName(c)):(n=ATTR_MODE_TAG_NAME,s.appendTagName(c)):s.markAsCloseTag()}}}}if(n!=ATTR_MODE_NONE)throw"[ERROR103] タグ内の値が終了しないままファイルの終端に達しました";if(a!=TAG_MODE_NONE)throw"[ERROR104] タグが閉じないままファイルの終端に達しました"}catch(t){throw e+" Line:"+T+" Char:"+A+"\n"+t}return{scripts:i,warnings:warnings}},exports.parseFiles=function(t){for(var e={},r=[],a=0;a<t.length;a++){var n=fs.readFileSync(path.normalize(t[a]),"utf8"),i=exports.parse(n,t[a]);e[path.basename(t[a])]=i.scripts;for(var s=0;s<i.warnings.length;s++)r.push("File: "+t[a]+" "+i.warnings[s])}return{scripts:e,warnings:r}},exports.configure=function(t){"legacy"in t&&(command.legacy=!!t.legacy),"release"in t&&(command.release=!!t.release),syntaxMode=command.legacy?SYNTAX_MODE_LEGACY:SYNTAX_MODE_STANDARD},exports.main=function(t){t.length||(console.log("Usage: builder.js FILE1 [FILE2 ...]"),process.exit(1));var e=t;return JSON.stringify(exports.parseFiles(e))},String.prototype.isOneOf=function(t){"string"==typeof t&&(t=[t]);for(var e=0;e<t.length;e++)if(this==t[e])return!0;return!1},"undefined"!=typeof module&&require.main===module)try{var result=exports.main(command.args);util.print(result)}catch(t){console.error(t)}
